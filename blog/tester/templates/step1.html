{% extends 'base.html' %}

{% block content %}
<h2>Step 2: Consumption Information</h2>
{% load static %}
<img hidden id="smoker" data-src="{% static 'tester/smoker.jpg' %}">
<img hidden id="cig" data-src="{% static 'tester/cig.png' %}">
<img hidden id="cig_end" data-src="{% static 'tester/cig_end.png' %}">
<form method="post">
    {% csrf_token %}
    {{ form.non_field_errors }} 
    <canvas id="myCanvas" width="400" height="400"></canvas>
    <div class="fieldWrapper">
        {{ form.smoking.errors }}
        {{ form.smoking.label_tag }}
        {{ form.smoking }}
    </div>
    <div class="fieldWrapper">
        {{ form.alcohol.errors }}
        {{ form.alcohol.label_tag }}
        {{ form.alcohol }}
    </div>
    <div class="fieldWrapper">
        {{ form.diet.errors }}
        {{ form.diet.label_tag }}
        {{ form.diet }}
    </div>
    <div class="fieldWrapper">
        {{ form.water.errors }}
        {{ form.water.label_tag }}
        {{ form.water.as_hidden }}
    </div>
    <p align="center" id="cups">Cups: </p>
    <div class="glass">
        <div class="water"></div>
    </div>
    <button id="next-button1" type="submit" class="btn btn-primary">Next</button>
</form>
    <style>
.glass {
    width: 200px;
    height: 300px;
    background-color: rgba(200, 200, 200, 0.2);
    border: 3px solid #000;
    position: relative;
    margin: 50px auto;
    clip-path: polygon(10% 0, 90% 0, 80% 100%, 20% 100%);
}

.water {
    background-color: #00f;
    width: 100%;
    height: 50%;
    position: absolute;
    bottom: 0;
    cursor: ns-resize; /* north-south resize cursor */
}
    </style>
    <script type="text/javascript">
    $(document).ready(function() {
        const canvas = document.getElementById('myCanvas');
const ctx = canvas.getContext('2d');
    let cigs = document.getElementById('cigs');

    var img = document.getElementById('smoker');
    img.src = img.getAttribute('data-src');
    
    var img2 = document.getElementById('cig');
    img2.src = img2.getAttribute('data-src');
    
    var img3 = document.getElementById('cig_end');
    img3.src = img3.getAttribute('data-src');
    img.onload = function() {
        ctx.drawImage(img, canvas.width/2-30, canvas.height/2-120, img.width/4, img.height/4); // Draws the image at position (0, 0) on the canvas
    };
function reset() {
    ctx.fillStyle = "white";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
}
function draw_cig(length=1) {
    reset();
    ctx.drawImage(img, canvas.width/2-30, canvas.height/2-120, img.width/4, img.height/4); // Draws the image at position (0, 0) on the canvas
    if (length >= 1) {
        ctx.drawImage(img2, 145, 215, img2.width/4, img2.height/4); // Draws the image at position (0, 0) on the canvas
    }
    for (var i=1; i<length; ++i) {
        ctx.drawImage(img3, 195-22*i, 282+10*i, img3.width/4, img3.height/4);
    }
}
// img3.onload = function() {
    // draw_cig(6);
// }


    let isDragging = false;
    let startY;
    let startHeight;
    let cups = document.getElementById('cups');

    cups.innerHTML = `Cups: ${getWaterHeight().toPrecision(2)}`;
    $(".water").on("mousedown", function(e) {
        isDragging = true;
        startY = e.pageY;
        startHeight = $(this).height();
    });

    $(document).on("mousemove", function(e) {
        if (isDragging) {
            let deltaY = startY - e.pageY;
            let newHeight = startHeight + deltaY;
            
            // Ensure the water height doesn't go out of the glass boundaries
            newHeight = Math.min($(".glass").height(), Math.max(1, newHeight));
            cups.innerHTML = `Cups: ${getWaterHeight().toPrecision(2)}`;
            $(".water").height(newHeight);
        }
    }).on("mouseup", function() {
        isDragging = false;
    });

    // To access the water height from JavaScript
    function getWaterHeight() {
        var range = $(".glass").height()
        return $(".water").height()/range*50;
    }

    const next_button = document.getElementById('next-button1');
    const hiddenInput = document.getElementById('id_water');
    
    next_button.addEventListener('click', function() {
        console.log("hell", getWaterHeight());
        hiddenInput.value = getWaterHeight().toPrecision(2);
    });

    const smoking_count = document.getElementById('id_smoking');
    smoking_count.addEventListener('click', function() {
        // console.log(smoking_count.value);
        draw_cig(smoking_count.value || 0);
        hiddenInput.value = getWaterHeight().toPrecision(2);
    });

});

    </script>

</form>

{% endblock %}
